# ABTest 系统设计

## 一. abtest 系统边界

- 单纯的用户分流，根据uid等，单纯的对比AB方案
- 任意维度的A/B，比如地域、性别、新老用户等

## 二. ABTest 实验的概念

```
实验的两个要素：
  1. 流量。其实就是selector，如何分流
  2. 参数。其实就是bucket/action ，分流后的动作

流量模型的几个基本概念
  1. 域（domain）是指流量的一个划分，流量进来首先是划分域。
  2. 层（layer）是指系统参数的一个子集。不同实验层间进行独立的流量划分和独立的实验，互不影响。
  3. 实验（experiment）是由多个策略参数构成的，最终用户只会命中其中之一的过程。

不同终端采用不同的用户标识 id 来 hash 分流
  1. web端采用 cookieId
  2. app端采用设备id
  3. 小程序端采用 openID 作为唯一标识符

正交性:
  在计算技术中，该术语用于表示某种不相依赖性或者解耦性。
  如果两个或者更多事物中的一个发生变化，不会影响其他事物, 这些事物就是正交的。
  在设计良好的系统中，数据库代码与用户界面是正交的：你可以改变界面，而不影响数据库，或者更换数据库，而不用改变界面。
```


## 各厂 ABTest 案例

### 1. 沪江 ABTest 案例

- [沪江ABTest测试平台实践](https://mp.weixin.qq.com/s/FjuUHg7YMdWUIoc4sp2TWA)
- [重叠实验：更多，更好，更快](https://static.googleusercontent.com/media/research.google.com/zh-CN//pubs/archive/36500.pdf)

``` doc
设计思想:
  基于 Google 论文《重叠实验：更多，更好，更快》，Overlapping Experiment Infrastructure:More, Better, Faster Experimentation。

  1. 流量：流量即用户的访问，也是实验的样本来源。
  2. 参数：或者称作实验变量，一个实验可能有多种策略或者模型需要在线上进行比较，这些策略或者模型就称作实验参数。

  通常产品或运营会要求同一时间做 N 个实验，想要同一份流量不同实验之间互不干扰，每个实验都能得到 100% 流量。


流量划分:
  请求只能在非重叠域或重叠域其中之一

  1. 非重叠域: 1 层
      如果请求在非重叠域, 那么请求最多在一个实验中（这个实验可以改变参数集合中的任意参数的值）

  2. 重叠域: N(3) 个层
      如果请求在重叠域，那么请求最多在三个实验中，每层一个实验。
      流量在每一层都会被重新打散。并且对于每个实验，只能使用对应层的参数。

  3. 该分层模型的主要思想为:
      同一实验的策略参数位于同一层
      相互独立的策略参数分属于不同的实验层
      不同实验层间进行独立的流量划分和独立的实验，互不影响
```

### 2. 阿里 ABTest 案例

- [阿里巴巴用户体验设计部博客 » A/B测试：基本概念](http://www.aliued.cn/2010/09/13/ab-testing-basic-concept.html)
- [阿里巴巴用户体验设计部博客 » A/B测试：实现方法](http://www.aliued.cn/2010/09/27/ab-testing-realization-method.html)

``` doc
A/B 测试最核心的思想:
  1. 多个方案并行测试
  2. 每个方案只有一个变量（比如鸟喙）不同
  3. 以某种规则优胜劣汰

对比性:
  需要特别留意的是第 2 点，它暗示了 A/B 测试的应用范围，——必须是单变量。有时我们的多个设计稿可能会有非常大的差异，这样的情况一般不太适合做 A/B 测试，因为它们的变量太多了，变量之间会有较多的干扰，我们很难通过 A/B 测试的方法来找出各个变量对结果的影响程度。比如，土豆烧肉和豆腐鲫鱼汤都挺美味，但我们很难比较土豆和豆腐哪一个对菜的美味影响更大，而土豆烧肉和豆腐烧肉则是不错的比较。另外，虽然 A/B 测试名字中只包含 A、B ，但并不是说它只能用于比较两个方案的好坏，事实上，你完全可以设计多个方案进行测试，“A/B 测试”这个名字只是一个习惯的叫法。

分流:
  要注意，不同的用户在他的一次浏览过程中，看到的应该一直是同一个方案。比如他一开始看到的是 A 方案，则在此次会话中应该一直向他展示 A 方案，而不能一会儿让他看 A 方案，一会儿让他看 B 方案。同时，还需要注意控制访问各个版本的人数，大多数情况下我们会希望将访问者平均分配到各个不同的版本上。要做到这些很简单，根据 cookie （比如 cookie 会话ID的最后一位数字）决定展示哪个版本就是一个不错的方法。

A/B 实现方案:
  1. 无 A/B 测试的普通访问流程（Non AB test）
  2. 基于后端的 A/B 测试访问流程（Back-end AB test）
  3. 基于前端的 A/B 测试访问流程（Front-end AB test）
```

### 1. 携程 ABTest 案例

- [携程机票的ABTest实践](https://zhuanlan.zhihu.com/p/25685006)

``` doc
分流计算:
  每个设备在刚启动的时候会根据设备号+试验号+随机数组成一串N位数，对 100 取模的余数.从 0-99
  假设 ABCD 四个版本流量 10:70:10:10 的情况下，则余数 0-9 为 A 版、10-79 为 B 版、80-89 为 C 版、90-99 为 D 版。A 版为默认版，如果尾数异常（Null或溢出），则走A版。

AB 版本:
  如果仅有新旧两个版本的情况下，一般会设置 ABCD 四个版本，（其中 ACD 为旧版，B 为新版；如果有多个迭代新版，则从 EFG 开始）来进行 AA 测试和 AB 测试。
  新版本: B
  旧版本: ACD

  1. AA 测试
    CD 版同为旧版，且流量各为 B 版一半，在流量随机分配的情况，通过对比CD版的数据表现来验证旧版的状态是稳定的。A 版作为旧版，也称为兜底版本，BCD 的剩余流量走 A 版，版本异常的情况下走 A 版。
  2. AB 测试
    在确保 CD 数据相对稳定的前提下，再对比 B 和 ACD 版本的数据，来对比新旧版的差异。

实验正交性:
  1. 非正交实验
    在旧版的基础上再做区分，会因为样本数量的问题而限制同时进行的实验个数，而且无法评估两个新版同时存在的影响。

  2. 正交试验
    不同实验流量完全打散随机分配，上一个实验与下一个实验理论上流量上没有关联，这样可以在一个页面同时进行多项实验。

```
